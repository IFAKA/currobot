# Builds and publishes installers automatically when commits matching conventional
# commit prefixes land on main, OR when a version tag is pushed manually.
#
# Automatic trigger rules:
#   feat: …   → bumps MINOR version  (0.1.x → 0.2.0)
#   fix:  …   → bumps PATCH version  (0.1.0 → 0.1.1)
#   release: … → bumps PATCH version
#
# Multiple commits pushed at once: only the HEAD commit message is evaluated.
# Concurrency: if a second push arrives while a build is running, the running
# build is cancelled and the newer push wins.
#
# Manual trigger: git tag v1.2.3 && git push origin v1.2.3
#
# Produces:
#   macOS arm64 — .dmg (ad-hoc signed)
#   Windows x64 — .msi

name: Release

on:
  push:
    branches: [main]
    tags: ['v*']

permissions:
  contents: write

# Cancel any in-progress build for the same ref so rapid pushes don't queue up
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Step 1: decide whether to release and bump the version ─────────────────
  # Runs only on branch pushes (tag pushes go straight to build).
  # Skips commits made by the bot itself ([skip ci]) to prevent loops.
  prepare:
    if: |
      github.ref_type == 'branch' &&
      !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      new_version:    ${{ steps.bump.outputs.new_version }}
      sha:            ${{ steps.push.outputs.sha }}

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Check commit message
        id: check
        run: |
          MSG="${{ github.event.head_commit.message }}"
          echo "HEAD commit: $MSG"
          if [[ "$MSG" == feat:* ]] || [[ "$MSG" == fix:* ]] || [[ "$MSG" == release:* ]]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            if [[ "$MSG" == feat:* ]]; then
              echo "bump=minor" >> $GITHUB_OUTPUT
            else
              echo "bump=patch" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Bump version in tauri.conf.json and package.json
        id: bump
        if: steps.check.outputs.should_release == 'true'
        run: |
          VERSION=$(jq -r '.version' frontend/src-tauri/tauri.conf.json)
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          if [ "${{ steps.check.outputs.bump }}" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi

          NEW="$MAJOR.$MINOR.$PATCH"
          echo "Bumping $VERSION → $NEW"
          echo "new_version=$NEW" >> $GITHUB_OUTPUT

          jq --arg v "$NEW" '.version = $v' frontend/src-tauri/tauri.conf.json \
            > /tmp/tauri.conf.json && mv /tmp/tauri.conf.json frontend/src-tauri/tauri.conf.json

          jq --arg v "$NEW" '.version = $v' frontend/package.json \
            > /tmp/package.json && mv /tmp/package.json frontend/package.json

      - name: Commit version bump and push
        id: push
        if: steps.check.outputs.should_release == 'true'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add frontend/src-tauri/tauri.conf.json frontend/package.json
          git commit -m "chore: bump version to ${{ steps.bump.outputs.new_version }} [skip ci]"
          git push origin main
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

  # ── Step 2: build installers ───────────────────────────────────────────────
  build:
    needs: prepare
    # Run when:
    #   a) triggered by a tag push (manual release), OR
    #   b) prepare decided to release (auto release from branch push)
    if: |
      always() && (
        github.ref_type == 'tag' ||
        (needs.prepare.result == 'success' && needs.prepare.outputs.should_release == 'true')
      )
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            rust-target: aarch64-apple-darwin
            label: macos-arm64
          - os: windows-latest
            rust-target: ''
            label: windows-x64

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.label }})

    steps:
      # Checkout the version-bumped commit on branch builds; HEAD on tag builds
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_type == 'branch' && needs.prepare.outputs.sha || github.ref }}

      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Set up Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust-target }}

      - name: Cache Rust build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: frontend/src-tauri

      - name: Install WeasyPrint system deps (macOS)
        if: runner.os == 'macOS'
        run: brew install pango cairo gdk-pixbuf gobject-introspection libffi

      - name: Install WeasyPrint system deps via MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-pango
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-gdk-pixbuf2
            mingw-w64-x86_64-libffi
            mingw-w64-x86_64-fontconfig

      - name: Add MSYS2 mingw64/bin to PATH (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: echo "C:/msys64/mingw64/bin" >> $GITHUB_PATH

      - name: Install Python deps and PyInstaller
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Python sidecar binary
        shell: bash
        run: |
          TRIPLE=$(rustc -vV | grep '^host:' | cut -d' ' -f2)
          echo "Target triple: $TRIPLE"
          pyinstaller backend.spec --distpath frontend/src-tauri/binaries/dist
          DST=frontend/src-tauri/binaries
          if [ -f "$DST/dist/jobbot-backend.exe" ]; then
            mv "$DST/dist/jobbot-backend.exe" "$DST/jobbot-backend-${TRIPLE}.exe"
          else
            mv "$DST/dist/jobbot-backend" "$DST/jobbot-backend-${TRIPLE}"
          fi
          echo "Sidecar: $DST/jobbot-backend-${TRIPLE}"
          ls -lh "$DST/"

      - name: Install frontend npm dependencies
        shell: bash
        run: |
          cd frontend
          rm -rf node_modules package-lock.json
          npm install

      # Resolve the release tag: for branch builds use the bumped version;
      # for manual tag builds use the pushed tag as-is.
      - name: Resolve release tag
        id: tag
        shell: bash
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag=v${{ needs.prepare.outputs.new_version }}" >> $GITHUB_OUTPUT
          fi

      - name: Build and release with tauri-action
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: frontend
          tagName:     ${{ steps.tag.outputs.tag }}
          releaseName: 'currobot ${{ steps.tag.outputs.tag }}'
          releaseBody: |
            ## Install

            | Platform | Download |
            |---|---|
            | macOS Apple Silicon (M1+) | `currobot_*_aarch64.dmg` |
            | Windows | `currobot_*_x64-setup.msi` |

            ### First-launch notes

            **macOS (unsigned):** Right-click the `.app` → Open, then click Open in
            the security dialog.  System Settings → Privacy & Security → Open Anyway
            also works.

            **Windows (unsigned):** If SmartScreen appears, click "More info" →
            "Run anyway".

            ### Requirements

            Install [Ollama](https://ollama.com/download) before launching — the app
            will guide you through the rest on first run.
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.rust-target != '' && format('--target {0}', matrix.rust-target) || '' }}
